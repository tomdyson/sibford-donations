{% extends 'tickets/base.html' %}

{% block title %}Book Tickets - Sibford Fundraising Event{% endblock %}

{% block content %}
<div class="bg-white rounded-lg shadow-sm border border-stone-200 overflow-hidden">
    <div class="p-6">
        <h2 class="text-2xl sm:text-3xl font-bold mb-6">Reserve your tickets</h2>

        <form method="post" x-data="{
            numTickets: 1,
            ticketPrice: {{ ticket_price }},
            totalDonation: {{ ticket_price }},
            giftAid: false,
            isSubmitting: false,
            get ticketCost() {
                return this.numTickets * this.ticketPrice;
            },
            get extraDonation() {
                const extra = parseFloat(this.totalDonation || 0) - this.ticketCost;
                return extra > 0 ? extra : 0;
            },
            updateTotalFromTickets() {
                this.totalDonation = this.ticketCost;
            }
        }" @submit="isSubmitting = true">
            {% csrf_token %}

            <div class="space-y-8">
                <!-- Personal Information -->
                <div class="border-b border-stone-200 pb-6">
                    <h3 class="text-lg font-semibold mb-4">Your Information</h3>

                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <label for="{{ form.full_name.id_for_label }}" class="block text-sm font-medium text-stone-700 mb-1">
                                Full Name*
                            </label>
                            {{ form.full_name }}
                            {% if form.full_name.errors %}
                            <p class="text-rose-600 text-sm mt-1">{{ form.full_name.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div>
                            <label for="{{ form.email.id_for_label }}" class="block text-sm font-medium text-stone-700 mb-1">
                                Email Address*
                            </label>
                            {{ form.email }}
                            {% if form.email.errors %}
                            <p class="text-rose-600 text-sm mt-1">{{ form.email.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Ticket Information -->
                <div class="border-b border-stone-200 pb-6">
                    <h3 class="text-lg font-semibold mb-4">Ticket Details</h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="{{ form.num_tickets.id_for_label }}" class="block text-sm font-medium text-stone-700 mb-1">
                                Number of Tickets*
                            </label>
                            <input type="number" name="num_tickets" id="{{ form.num_tickets.id_for_label }}"
                                class="w-full px-4 py-2 border border-stone-300 rounded-md focus:ring-2 focus:ring-stone-500 focus:border-stone-500"
                                min="1"
                                x-model="numTickets"
                                @input="updateTotalFromTickets()">
                            {% if form.num_tickets.errors %}
                            <p class="text-rose-600 text-sm mt-1">{{ form.num_tickets.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-stone-700 mb-1">
                                Ticket Donations
                            </label>
                            <div class="w-full px-4 py-2 border border-stone-300 rounded-md bg-stone-50 text-stone-700">
                                £<span x-text="ticketCost"></span>
                            </div>
                            <p class="text-sm text-stone-500 mt-1">
                                Suggested donation: £{{ ticket_price }} per ticket
                            </p>
                        </div>

                        <div class="md:col-span-2">
                            <label for="total_donation_display" class="block text-sm font-medium text-stone-700 mb-1">
                                Total Donation (£)*
                            </label>
                            <input type="number" name="total_donation_display" id="total_donation_display"
                                class="w-full px-4 py-2 border-2 border-stone-400 rounded-md focus:ring-2 focus:ring-stone-500 focus:border-stone-500 font-semibold text-lg"
                                min="1"
                                x-model.number="totalDonation">
                            {{ form.extra_donation }}
                            <p class="text-sm text-stone-500 mt-1">
                                Edit to adjust your total donation. If you can add anything, we'd be very grateful.
                            </p>
                            {% if form.extra_donation.errors %}
                            <p class="text-rose-600 text-sm mt-1">{{ form.extra_donation.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Gift Aid Information -->
                <div>
                    <h3 class="text-lg font-semibold mb-4">Gift Aid</h3>

                    <div class="mb-4">
                        <div class="flex items-start">
                            <input type="checkbox" name="gift_aid" id="{{ form.gift_aid.id_for_label }}"
                                class="mt-1 mr-2 h-4 w-4 rounded border-stone-300 text-stone-600 focus:ring-stone-500"
                                x-model="giftAid">
                            <label for="{{ form.gift_aid.id_for_label }}" class="text-sm text-stone-700">
                                I would like to Gift Aid this donation
                            </label>
                        </div>
                        <p class="text-sm text-stone-500 mt-1 pl-6">
                            Gift Aid allows us to claim an extra 25% from the tax you pay, at no extra cost to you.
                        </p>
                    </div>

                    <div x-show="giftAid" class="bg-stone-50 p-4 rounded-md border border-stone-200 space-y-4" x-cloak>
                        <div class="mb-4">
                            <div class="flex items-start">
                                <input type="checkbox" name="gift_aid_confirmation" id="{{ form.gift_aid_confirmation.id_for_label }}"
                                    class="mt-1 mr-2 h-4 w-4 rounded border-stone-300 text-stone-600 focus:ring-stone-500">
                                <label for="{{ form.gift_aid_confirmation.id_for_label }}" class="text-sm text-stone-700">
                                    {{ form.gift_aid_confirmation.label }}
                                </label>
                            </div>
                            {% if form.gift_aid_confirmation.errors %}
                            <p class="text-rose-600 text-sm mt-1 pl-6">{{ form.gift_aid_confirmation.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="{{ form.address_line1.id_for_label }}" class="block text-sm font-medium text-stone-700 mb-1">
                                    Address Line 1*
                                </label>
                                {{ form.address_line1 }}
                                {% if form.address_line1.errors %}
                                <p class="text-rose-600 text-sm mt-1">{{ form.address_line1.errors.0 }}</p>
                                {% endif %}
                            </div>

                            <div>
                                <label for="{{ form.address_line2.id_for_label }}" class="block text-sm font-medium text-stone-700 mb-1">
                                    Address Line 2 (optional)
                                </label>
                                {{ form.address_line2 }}
                            </div>

                            <div>
                                <label for="{{ form.city.id_for_label }}" class="block text-sm font-medium text-stone-700 mb-1">
                                    City/Town*
                                </label>
                                {{ form.city }}
                                {% if form.city.errors %}
                                <p class="text-rose-600 text-sm mt-1">{{ form.city.errors.0 }}</p>
                                {% endif %}
                            </div>

                            <div>
                                <label for="{{ form.postcode.id_for_label }}" class="block text-sm font-medium text-stone-700 mb-1">
                                    Postcode*
                                </label>
                                {{ form.postcode }}
                                {% if form.postcode.errors %}
                                <p class="text-rose-600 text-sm mt-1">{{ form.postcode.errors.0 }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-center pt-4">
                    <button type="submit" 
                            :disabled="isSubmitting"
                            class="px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-stone-800 hover:bg-stone-900 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-stone-500 disabled:opacity-50 disabled:cursor-not-allowed transition-opacity">
                        <span x-show="!isSubmitting">Book Tickets</span>
                        <span x-show="isSubmitting" class="flex items-center justify-center">
                            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            Processing...
                        </span>
                    </button>
                    <p x-show="isSubmitting" class="text-sm text-stone-600 mt-2">
                        Please wait while we process your booking...
                    </p>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Update form fields with proper styling
    document.addEventListener('DOMContentLoaded', function() {
        const inputs = document.querySelectorAll('input[type="text"], input[type="email"], input[type="number"]');
        inputs.forEach(input => {
            if (!input.classList.contains('w-full')) {
                input.classList.add('w-full', 'px-4', 'py-2', 'border', 'border-stone-300', 'rounded-md', 'focus:ring-2', 'focus:ring-stone-500', 'focus:border-stone-500');
            }
        });

        // Sync the extra_donation hidden field before form submission
        const form = document.querySelector('form');
        form.addEventListener('submit', function() {
            const totalDonationInput = document.getElementById('total_donation_display');
            const numTicketsInput = document.querySelector('input[name="num_tickets"]');
            const extraDonationInput = document.querySelector('input[name="extra_donation"]');
            
            const totalDonation = parseInt(totalDonationInput.value) || 0;
            const numTickets = parseInt(numTicketsInput.value) || 1;
            const ticketCost = numTickets * {{ ticket_price }};
            const extraDonation = Math.max(0, totalDonation - ticketCost);
            
            extraDonationInput.value = extraDonation;
        });
    });
</script>
{% endblock %}
